# Epic 3: 核心记账功能测试指南

## 测试前准备

1. **安装依赖**
   ```bash
   cd web
   npm install
   ```

2. **启动开发服务器**
   ```bash
   npm run dev
   ```

3. **打开浏览器**
   - 访问 `http://localhost:5173`（或Vite显示的端口）
   - 使用Chrome或Edge浏览器（语音识别需要）

---

## 测试场景

### 场景1: 手动输入记账功能

**测试步骤：**
1. 登录应用
2. 点击"记账"或导航到 `/accounting`
3. 点击"新建账目"按钮
4. 填写表单：
   - 金额：`100.50`
   - 日期：选择今天
   - 类别：选择"餐饮"
   - 备注：`测试手动输入`
5. 点击"预览"按钮，确认信息显示正确
6. 点击"确认入账"按钮
7. 验证：检查是否显示成功消息，账目是否出现在列表中

**预期结果：**
- ✅ 表单验证正常工作（金额必须>0，日期和类别必填）
- ✅ 预览功能正常显示
- ✅ 账目成功保存并显示在列表中
- ✅ 金额格式正确（¥100.50）
- ✅ 日期格式正确（中文格式）

---

### 场景2: 账目列表查看功能

**测试步骤：**
1. 导航到 `/accounting`
2. 查看账目列表
3. 验证列表显示：
   - 账目按时间倒序排列（最新的在前）
   - 每个账目显示：金额、类别、日期、备注
   - 有编辑和删除按钮
4. 如果账目超过50条，测试"加载更多"功能

**预期结果：**
- ✅ 列表正确显示所有账目
- ✅ 账目按时间倒序排列
- ✅ 分页功能正常（如果有超过50条）
- ✅ 每个账目信息完整显示

---

### 场景3: 账目编辑功能

**测试步骤：**
1. 在账目列表中，点击某个账目的"编辑"按钮
2. 修改账目信息：
   - 修改金额：`200.00`
   - 修改类别：选择"购物"
   - 修改备注：`已编辑的账目`
3. 点击"保存"按钮
4. 验证：返回列表，检查账目是否已更新

**预期结果：**
- ✅ 编辑表单正确加载原有数据
- ✅ 可以修改所有字段
- ✅ 保存后数据正确更新
- ✅ 返回列表后显示更新后的数据

---

### 场景4: 账目删除功能

**测试步骤：**
1. 在账目列表中，点击某个账目的"删除"按钮
2. 确认删除对话框
3. 验证：账目从列表中消失

**预期结果：**
- ✅ 删除前显示确认对话框
- ✅ 确认后账目被删除
- ✅ 取消删除时账目保留

---

### 场景5: 搜索和筛选功能

**测试步骤：**

#### 5.1 关键词搜索
1. 在搜索框输入：`餐饮`
2. 验证：只显示包含"餐饮"的账目

#### 5.2 类别筛选
1. 在类别筛选下拉框选择"餐饮"
2. 验证：只显示餐饮类别的账目

#### 5.3 日期范围筛选
1. 选择开始日期和结束日期
2. 验证：只显示该日期范围内的账目

#### 5.4 组合筛选
1. 同时使用搜索、类别、日期筛选
2. 验证：筛选结果正确

#### 5.5 清除筛选
1. 点击"清除"按钮
2. 验证：所有筛选被清除，显示全部账目

**预期结果：**
- ✅ 搜索功能正常工作
- ✅ 类别筛选正常工作
- ✅ 日期范围筛选正常工作
- ✅ 组合筛选正常工作
- ✅ 清除筛选功能正常

---

### 场景6: 发票扫描识别（OCR）

**测试步骤：**
1. 导航到 `/accounting/scan` 或从创建表单点击"发票扫描"
2. 点击"选择图片"按钮
3. 选择一张包含发票/账单的图片（建议使用清晰的发票图片）
4. 点击"识别发票"按钮
5. 等待OCR识别完成（可能需要几秒钟）
6. 验证：
   - 识别结果是否正确提取了金额、日期、商户信息
   - 表单是否自动填充了识别结果
7. 可以手动修改识别结果
8. 点击"确认入账"保存

**预期结果：**
- ✅ 图片上传功能正常
- ✅ OCR识别能够提取金额
- ✅ OCR识别能够提取日期
- ✅ OCR识别能够提取商户信息（如果有）
- ✅ 识别结果自动填充到表单
- ✅ 可以手动编辑识别结果
- ✅ 确认入账功能正常

**注意：**
- OCR识别质量取决于图片清晰度
- 中文识别需要加载中文语言包（首次使用可能较慢）
- 如果识别失败，可以手动输入

---

### 场景7: 语音输入识别

**测试步骤：**
1. 导航到 `/accounting/voice` 或从创建表单点击"语音输入"
2. 确保浏览器支持语音识别（Chrome/Edge）
3. 点击麦克风图标开始录音
4. 说出账目信息，例如："花了50元，餐饮，今天"
5. 等待识别完成
6. 验证：
   - 识别文本是否正确显示
   - 金额、类别是否自动解析
   - 表单是否自动填充
7. 可以手动修改识别结果
8. 点击"确认入账"保存

**预期结果：**
- ✅ 语音识别功能正常（Chrome/Edge浏览器）
- ✅ 能够识别中文语音
- ✅ 能够解析金额、类别等信息
- ✅ 识别结果自动填充到表单
- ✅ 可以手动编辑识别结果
- ✅ 确认入账功能正常

**注意：**
- 需要浏览器支持Web Speech API
- 需要麦克风权限
- 语音识别准确度取决于发音清晰度

---

### 场景8: 短信解析识别

**测试步骤：**
1. 导航到 `/accounting/sms` 或从创建表单点击"短信解析"
2. 在文本框中粘贴一条消费短信，例如：
   ```
   支付宝向XXX餐厅支付了100.50元，时间：2026-01-26 12:30
   ```
3. 点击"解析短信"按钮
4. 验证：
   - 金额是否正确解析
   - 日期是否正确解析
   - 商户信息是否正确解析
   - 类别是否自动推断
5. 可以手动修改解析结果
6. 点击"确认入账"保存

**预期结果：**
- ✅ 短信解析功能正常
- ✅ 能够解析支付宝、微信支付等常见格式
- ✅ 能够提取金额、日期、商户信息
- ✅ 能够自动推断类别
- ✅ 解析结果自动填充到表单
- ✅ 可以手动编辑解析结果
- ✅ 确认入账功能正常

---

### 场景9: 数据加密验证

**测试步骤：**
1. 创建几条账目
2. 打开浏览器开发者工具
3. 打开Application > IndexedDB > greenprj_db > accounts
4. 检查存储的数据：
   - 如果数据已加密，应该看到 `encrypted`、`salt`、`iv` 字段
   - 不应该看到明文的 `amount`、`category` 等字段
5. 验证：登录状态下，应用能够正确解密和显示数据

**预期结果：**
- ✅ 数据在数据库中加密存储
- ✅ 登录状态下能够正确解密显示
- ✅ 未登录状态下无法访问数据

---

### 场景10: 统一确认入账按钮

**测试步骤：**
1. 测试所有输入方式：
   - 手动输入
   - 发票扫描
   - 语音输入
   - 短信解析
2. 验证：所有方式都使用相同的"确认入账"按钮
3. 验证：点击后都使用相同的保存流程

**预期结果：**
- ✅ 所有输入方式都使用统一的"确认入账"按钮
- ✅ 所有方式都使用相同的保存流程
- ✅ 用户体验一致

---

## 浏览器控制台测试脚本

### 快速验证脚本

在浏览器控制台运行以下脚本进行快速验证：

```javascript
// 测试账目数据
async function testAccountingFeatures() {
  console.log('🧪 开始测试记账功能...\n')
  
  // 1. 检查数据库
  const db = await new Promise((resolve, reject) => {
    const request = indexedDB.open('greenprj_db', 1)
    request.onsuccess = () => resolve(request.result)
    request.onerror = () => reject(request.error)
  })
  
  const tx = db.transaction(['accounts'], 'readonly')
  const store = tx.objectStore('accounts')
  const count = await new Promise((resolve) => {
    const request = store.count()
    request.onsuccess = () => resolve(request.result)
  })
  
  console.log(`✅ 数据库连接: 正常`)
  console.log(`📊 账目总数: ${count}\n`)
  
  // 2. 检查最近的账目
  const index = store.index('by-date')
  const entries = await new Promise((resolve) => {
    const entries = []
    const request = index.openCursor(null, 'prev')
    request.onsuccess = (e) => {
      const cursor = e.target.result
      if (cursor && entries.length < 5) {
        entries.push(cursor.value)
        cursor.continue()
      } else {
        resolve(entries)
      }
    }
  })
  
  console.log(`📝 最近5条账目:`)
  entries.forEach((entry, i) => {
    if (entry.encrypted) {
      console.log(`  ${i + 1}. [加密数据] ID: ${entry.id}`)
    } else {
      console.log(`  ${i + 1}. 金额: ¥${entry.amount}, 类别: ${entry.category}, 日期: ${entry.date}`)
    }
  })
  
  db.close()
  console.log('\n✨ 测试完成！')
}

// 运行测试
testAccountingFeatures()
```

---

## 已知问题和限制

1. **OCR识别**
   - 首次使用需要下载语言包，可能较慢
   - 识别准确度取决于图片质量
   - 建议使用清晰的发票图片

2. **语音识别**
   - 仅支持Chrome和Edge浏览器
   - 需要麦克风权限
   - 识别准确度取决于发音清晰度

3. **数据加密**
   - 当前实现中，密码临时存储在session中（MVP阶段）
   - 生产环境需要更安全的密钥管理方案

4. **浏览器兼容性**
   - 语音识别：Chrome/Edge
   - OCR：所有现代浏览器
   - 短信解析：所有浏览器

---

## 测试检查清单

- [ ] 手动输入记账功能
- [ ] 账目列表查看功能
- [ ] 账目编辑功能
- [ ] 账目删除功能
- [ ] 搜索功能
- [ ] 类别筛选功能
- [ ] 日期范围筛选功能
- [ ] 发票扫描识别（OCR）
- [ ] 语音输入识别
- [ ] 短信解析识别
- [ ] 数据加密验证
- [ ] 统一确认入账按钮

---

## 问题报告

如果发现任何问题，请记录：
1. 测试场景编号
2. 具体操作步骤
3. 预期结果
4. 实际结果
5. 浏览器和版本
6. 控制台错误信息（如果有）
